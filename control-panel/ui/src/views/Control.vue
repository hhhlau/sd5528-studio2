<template>
  <div :class="`control-container ${isPresenterView ? 'l-space-only' : ''}`">
    <div class="left-container">
      <div class="liveview-block">
        <img
          src="http://192.168.0.9:8080/stream.mjpg"
          class="car-live-view"
          alt=""
        />
      </div>
      <div class="scene-selection-block">
        <CarControl :socket="_socket"></CarControl>
      </div>
    </div>
    <div class="right-container">
      <div class="chart-block">
        <svg
          id="chart"
          ref="chart"
          width="100%"
          height="100%"
          viewBox="0 0 200 200"
          xmlns="http://www.w3.org/2000/svg"
        >
          <polygon
            id="l-space"
            fill="#FF0066"
            points="37.305090430340165,-26.39487297089126 38.711608786124266,-24.97942810346139 40.11266010388499,-23.569613418856168 41.529185717042125,-22.14106423888734 42.935799631722325,-20.716115835007802 44.32786583247361,-19.296373561106158 45.721358063851945,-17.86226670400938 47.11134979343187,-16.415197847424132 48.48277400089428,-14.967203589063137 49.8503318684714,-13.498669751752459 51.19837133078981,-12.021765052028059 52.53034659077385,-10.527654787029313 53.839316604989286,-9.018215158853854 55.126434738282114,-7.485070248041302 56.38257294887444,-5.930614398641047 58.78290344298584,-2.7381884615751915 59.914419286197514,-1.0870018556364816 60.9812643520534,0.6014640875160691 61.97276924968463,2.341061537351925 62.86908894871594,4.14332887501223 63.62539432988269,5.979814555880148 64.21820711651816,7.894425115641207 64.58155772386817,9.852894068614114 64.6486501321313,11.853955081745516 64.34669011662481,13.827156199060846 62.599957558047024,17.3984938072972 61.317698509956244,18.928371129615698 59.86770753028104,20.30694121081615 58.296356652851685,21.563856849155854 56.671388237643974,22.69961830051616 54.97890858427854,23.761634952679742 53.235845022615095,24.762884520810623 51.47614661827683,25.703104255348446 49.685702943999786,26.604603581421543 47.891462977638,27.465160187275615 46.069453193955994,28.305201114759257 44.242148456443104,29.121419299859554 42.40564314069924,29.921765569678975 40.56767962679295,30.708119600343345 38.72132401220733,31.487992827838752 36.88658595038578,32.25699531612918 35.04059918928688,33.02834590042039 33.18782313480769,33.80350193401828 31.347197505416986,34.57765323854255 29.50832749083638,35.358089316636324 27.675041750166564,36.146012619975956 25.836154556274415,36.949097061157225 24.009991234615153,37.76214302062726 22.185135507059748,38.59301038210979 20.37975303530693,39.43615195155144 18.58226088874508,40.302734810207035 16.779907883089617,41.202873859379906 15.002559254548395,42.1129670112743 13.23606000102882,43.036828054639045 11.46661156658083,43.97872310951352 9.709291434005717,44.927622293063905 7.950521440347075,45.88776387757389 6.2052051911334285,46.84786142803496 4.4461025508499,47.81969629769446 2.702069380352623,48.78400045231683 0.9463945692725242,49.75201675341232 -0.8060105232521892,50.71178169623017 -2.567480211870862,51.66602624602383 -4.336496178247034,52.60947151705623 -6.098395139514468,53.529685464221984 -7.89071481693536,54.44077519401908 -9.685225944221019,55.322086435556415 -11.492617128908751,56.172234303166626 -13.322718398715368,56.98767958143726 -15.160098361968993,57.75248832702637 -17.037682828493416,58.46900271996856 -18.926984642632306,59.11293002590537 -20.84685697739478,59.67544925259426 -22.79141949212644,60.13580383388326 -24.754320430755616,60.470842361450195 -28.748186959954907,60.65731082046405 -30.741242694854733,60.443053817749025 -32.67942253053188,59.986616937816144 -34.55043651196174,59.26583685313817 -36.30793202221393,58.331297828257085 -37.96855985559523,57.199796326644716 -39.49897785088979,55.92174516066443 -40.917527846619485,54.51167709585279 -42.22559566809795,52.99267963271123 -43.42493498660623,51.38595199603587 -44.51159253953374,49.72079661553435 -45.506126997992396,47.98520433362573 -46.40329940654337,46.20332691688091 -47.20922250668518,44.37765713015106 -47.93233262002468,42.49691502302885 -48.55916615406167,40.605767445979296 -49.100963084818794,38.67968446093146 -49.55263803005218,36.739701831340795 -49.91916216425597,34.75870966967195 -50.19042182681733,32.78181656487577 -50.36791598238051,30.781786211021245 -50.44506797575741,28.792178769476596 -50.418254491686824,26.798611567914485 -50.27972017559223,24.800020055822095 -50.022375552402806,22.819898142502645 -49.63389751431532,20.848427324392834 -49.11936340332031,18.912161254882815 -48.474050405342126,17.020054677594455 -47.70789278522133,15.19243439808488 -46.80876717567444,13.384966897964478 -45.81304694277932,11.651707359438296 -44.73296899950364,9.985120200517121 -42.33722514510155,6.788838523626327 -41.04019986494677,5.2472296916064805 -39.71506727337837,3.763799315690995 -38.34116422113729,2.2984923830139454 -36.94273087295005,0.8628415956744 -34.10684765493497,-1.9403092012740668 -32.66817285427824,-3.333989825006575 -31.228154483034444,-4.72571865873906 -29.793780762878303,-6.119855433002522 -28.371794154250523,-7.520599839428906 -26.960184343058785,-8.940667328816199 -25.565579748153688,-10.384411478042603 -24.202833251003177,-11.847172878589483 -21.58898514924804,-14.853964091313538 -20.334772487718144,-16.42492955896305 -19.128708179597744,-18.028532196488232 -17.98357452023774,-19.648956909030677 -16.867820261418817,-21.319910746812823 -15.792551209591329,-23.01390451863408 -14.754455280303954,-24.72323570251465 -13.75022038910538,-26.440201776474716 -11.79593302637804,-29.92851110240445 -10.840908800624309,-31.682993657141928 -9.886050166585484,-33.452273588906976 -8.939503761962987,-35.205311297159646 -7.976751816272735,-36.969333028793336 -7.005055241310037,-38.710044289659706 -5.999535925500095,-40.44670523181558 -4.955374452075921,-42.15579767273739 -3.855940568842925,-43.825143014919014 -2.6824917085701605,-45.43246815605089 -1.391573618911207,-46.965977961570026 0.03404312133789045,-48.35105285644531 1.6638981716008856,-49.524766785744575 3.4852265355642884,-50.32715336745605 5.458736672997475,-50.66320615410804 7.4531234446913,-50.51898595467209 9.379447975754736,-50.0127309858799 11.22774588386528,-49.25260359151288 12.993046069145201,-48.32001605033875 14.690390675188974,-47.264500729460266 16.331943265226435,-46.118906631960996 17.91681782901287,-44.91418563723564 19.479661097610368,-43.6455027856864 20.98990362123586,-42.3547275529243 22.494785589491947,-41.01477791285143 23.95584411867894,-39.67045784378424 25.414573065185685,-38.29254546718439 26.859918618202208,-36.898113489151 28.28035259544849,-35.50471251606941 29.70210210694931,-34.09192360481247 31.114355070778398,-32.674914332490886 32.52543319971301,-31.24939277777448 33.92437150478363,-29.830114889144898 35.32985866824747,-28.40144745694706 36.731119552254675,-26.977388340234757"
            transform="translate(100 100)"
          />
          <g transform="translate(50 50)" width="50" height="50">
            <template v-if="detectedCount > 0">
              <template v-for="(item, index) in detected">
                <circle
                  v-if="item.pert > 0.65 && item.type === 'puddle'"
                  :class="`item-spot ${item.type}`"
                  :cx="40 * item.x"
                  :cy="30 * item.y"
                  r="5"
                  :key="`${item.type}-${index}`"
                />
              </template>
            </template>
          </g>
          <g transform="translate(150 50)" width="50" height="50">
            <template v-if="detectedCount > 0">
              <template v-for="(item, index) in detected">
                <circle
                  v-if="item.pert > 0.65 && item.type === 'human'"
                  :class="`item-spot ${item.type}`"
                  :cx="40 * item.x"
                  :cy="30 * item.y"
                  r="5"
                  :key="`${item.type}-${index}`"
                />
              </template>
            </template>
          </g>
        </svg>
      </div>
      <!-- <div class="msg-block">
        <v-btn color="error" @click="test3">text</v-btn>
      </div> -->
    </div>
    <div :class="`overlay-block ${isPresenterView ? '' : 'd-none'}`">
      <h1>Latent Space</h1>
      <p>
        The word “latent” means “hidden”.<br />It is a concept of deep learning
        which is a representation of compressed data. The values of compression
        is to get rid of any extraneous information, and only focus on the most
        important features including edges, angles… In this space, YOLOv3
        recognize some objects and map them in to a space as coordinates where
        similar data are closer together on the graph.
        <strong>black point</strong> represents <strong>puddle</strong>, while
        <strong>Green point</strong> represents <strong>human</strong>. And
        coordinates of these points depends on line combination of some features
        related to “safe” concept. The
        <strong style="color: red">red area </strong> represents
        <strong>“safe” zone</strong>, which means AI’ reasoning influenced by
        user input. If points are inclusive in “safe” zone with means AI see the
        scene as safe, AI would control the car just run though the puddle.
        Otherwise, the car would slow down.
      </p>
      <div class="liveview-view">
        <p class="title">What I see</p>
        <img
          src="http://192.168.0.9:8080/stream.mjpg"
          class="car-live-view"
          alt=""
        />
      </div>
    </div>
    <div class="scenario-labeling">
      <p class="scene-stage">Demo scenario {{ currentScene }}</p>
      <p class="scene-description">{{ scenesDescription[currentScene - 1] }}</p>
    </div>
    <p class="control-hint">
      <strong>Keyboard shortcut: </strong>[p]: toggle presenter view; [1-5]:
      Select scenarios; [0]: Reset senario;
    </p>
    <v-dialog v-model="isSceneDialog" persistent max-width="50%">
      <v-card>
        <v-card-title class="headline">
          Prefer me not to slow down next time?
        </v-card-title>
        <v-card-text>
          <p>
            It would be great if you can provide me the reasoning behind this
            behavior so that I can know how and why to react next time
          </p>
          <v-combobox
            :items="[
              `it doesn’t matter`,
              `it’s not harmful`,
              `Slow down makes me feel bad`,
              `No effect on my car’s performance`,
              `I enjoy steady speed`,
              `Puddle is very shallow`,
              `I don’t care small puddle`,
            ]"
            label="Possible reasoning"
            multiple
            chips
            persistent-hint
          ></v-combobox>
        </v-card-text>
        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn color="error darken-1" text @click="isSceneDialog = false">
            Cancel
          </v-btn>
          <v-btn color="success" large @click="processReasoning">
            Confirm
          </v-btn>
        </v-card-actions>
        <v-overlay :value="isLoadingOverlay" absolute>
          <v-progress-circular
            :size="70"
            :width="7"
            color="purple"
            indeterminate
          ></v-progress-circular>
        </v-overlay>
      </v-card>
    </v-dialog>
  </div>
</template>

<script>
import CarControl from "@/components/CarControl";
import anime from "animejs";
import { onMounted, ref, computed, watch } from "@vue/composition-api";

// function delay(ms) {
//   return new Promise(function (resolve) {
//     setTimeout(function () {
//       resolve();
//     }, ms);
//   });
// }

export default {
  name: "Control",
  components: { CarControl },
  setup() {
    const detected = ref([]);
    const isPresenterView = ref(true);
    const _socket = new WebSocket("ws://192.168.0.2:82/client");
    const spacePaths = [
      "37.305090430340165,-26.39487297089126 38.711608786124266,-24.97942810346139 40.11266010388499,-23.569613418856168 41.529185717042125,-22.14106423888734 42.935799631722325,-20.716115835007802 44.32786583247361,-19.296373561106158 45.721358063851945,-17.86226670400938 47.11134979343187,-16.415197847424132 48.48277400089428,-14.967203589063137 49.8503318684714,-13.498669751752459 51.19837133078981,-12.021765052028059 52.53034659077385,-10.527654787029313 53.839316604989286,-9.018215158853854 55.126434738282114,-7.485070248041302 56.38257294887444,-5.930614398641047 58.78290344298584,-2.7381884615751915 59.914419286197514,-1.0870018556364816 60.9812643520534,0.6014640875160691 61.97276924968463,2.341061537351925 62.86908894871594,4.14332887501223 63.62539432988269,5.979814555880148 64.21820711651816,7.894425115641207 64.58155772386817,9.852894068614114 64.6486501321313,11.853955081745516 64.34669011662481,13.827156199060846 62.599957558047024,17.3984938072972 61.317698509956244,18.928371129615698 59.86770753028104,20.30694121081615 58.296356652851685,21.563856849155854 56.671388237643974,22.69961830051616 54.97890858427854,23.761634952679742 53.235845022615095,24.762884520810623 51.47614661827683,25.703104255348446 49.685702943999786,26.604603581421543 47.891462977638,27.465160187275615 46.069453193955994,28.305201114759257 44.242148456443104,29.121419299859554 42.40564314069924,29.921765569678975 40.56767962679295,30.708119600343345 38.72132401220733,31.487992827838752 36.88658595038578,32.25699531612918 35.04059918928688,33.02834590042039 33.18782313480769,33.80350193401828 31.347197505416986,34.57765323854255 29.50832749083638,35.358089316636324 27.675041750166564,36.146012619975956 25.836154556274415,36.949097061157225 24.009991234615153,37.76214302062726 22.185135507059748,38.59301038210979 20.37975303530693,39.43615195155144 18.58226088874508,40.302734810207035 16.779907883089617,41.202873859379906 15.002559254548395,42.1129670112743 13.23606000102882,43.036828054639045 11.46661156658083,43.97872310951352 9.709291434005717,44.927622293063905 7.950521440347075,45.88776387757389 6.2052051911334285,46.84786142803496 4.4461025508499,47.81969629769446 2.702069380352623,48.78400045231683 0.9463945692725242,49.75201675341232 -0.8060105232521892,50.71178169623017 -2.567480211870862,51.66602624602383 -4.336496178247034,52.60947151705623 -6.098395139514468,53.529685464221984 -7.89071481693536,54.44077519401908 -9.685225944221019,55.322086435556415 -11.492617128908751,56.172234303166626 -13.322718398715368,56.98767958143726 -15.160098361968993,57.75248832702637 -17.037682828493416,58.46900271996856 -18.926984642632306,59.11293002590537 -20.84685697739478,59.67544925259426 -22.79141949212644,60.13580383388326 -24.754320430755616,60.470842361450195 -28.748186959954907,60.65731082046405 -30.741242694854733,60.443053817749025 -32.67942253053188,59.986616937816144 -34.55043651196174,59.26583685313817 -36.30793202221393,58.331297828257085 -37.96855985559523,57.199796326644716 -39.49897785088979,55.92174516066443 -40.917527846619485,54.51167709585279 -42.22559566809795,52.99267963271123 -43.42493498660623,51.38595199603587 -44.51159253953374,49.72079661553435 -45.506126997992396,47.98520433362573 -46.40329940654337,46.20332691688091 -47.20922250668518,44.37765713015106 -47.93233262002468,42.49691502302885 -48.55916615406167,40.605767445979296 -49.100963084818794,38.67968446093146 -49.55263803005218,36.739701831340795 -49.91916216425597,34.75870966967195 -50.19042182681733,32.78181656487577 -50.36791598238051,30.781786211021245 -50.44506797575741,28.792178769476596 -50.418254491686824,26.798611567914485 -50.27972017559223,24.800020055822095 -50.022375552402806,22.819898142502645 -49.63389751431532,20.848427324392834 -49.11936340332031,18.912161254882815 -48.474050405342126,17.020054677594455 -47.70789278522133,15.19243439808488 -46.80876717567444,13.384966897964478 -45.81304694277932,11.651707359438296 -44.73296899950364,9.985120200517121 -42.33722514510155,6.788838523626327 -41.04019986494677,5.2472296916064805 -39.71506727337837,3.763799315690995 -38.34116422113729,2.2984923830139454 -36.94273087295005,0.8628415956744 -34.10684765493497,-1.9403092012740668 -32.66817285427824,-3.333989825006575 -31.228154483034444,-4.72571865873906 -29.793780762878303,-6.119855433002522 -28.371794154250523,-7.520599839428906 -26.960184343058785,-8.940667328816199 -25.565579748153688,-10.384411478042603 -24.202833251003177,-11.847172878589483 -21.58898514924804,-14.853964091313538 -20.334772487718144,-16.42492955896305 -19.128708179597744,-18.028532196488232 -17.98357452023774,-19.648956909030677 -16.867820261418817,-21.319910746812823 -15.792551209591329,-23.01390451863408 -14.754455280303954,-24.72323570251465 -13.75022038910538,-26.440201776474716 -11.79593302637804,-29.92851110240445 -10.840908800624309,-31.682993657141928 -9.886050166585484,-33.452273588906976 -8.939503761962987,-35.205311297159646 -7.976751816272735,-36.969333028793336 -7.005055241310037,-38.710044289659706 -5.999535925500095,-40.44670523181558 -4.955374452075921,-42.15579767273739 -3.855940568842925,-43.825143014919014 -2.6824917085701605,-45.43246815605089 -1.391573618911207,-46.965977961570026 0.03404312133789045,-48.35105285644531 1.6638981716008856,-49.524766785744575 3.4852265355642884,-50.32715336745605 5.458736672997475,-50.66320615410804 7.4531234446913,-50.51898595467209 9.379447975754736,-50.0127309858799 11.22774588386528,-49.25260359151288 12.993046069145201,-48.32001605033875 14.690390675188974,-47.264500729460266 16.331943265226435,-46.118906631960996 17.91681782901287,-44.91418563723564 19.479661097610368,-43.6455027856864 20.98990362123586,-42.3547275529243 22.494785589491947,-41.01477791285143 23.95584411867894,-39.67045784378424 25.414573065185685,-38.29254546718439 26.859918618202208,-36.898113489151 28.28035259544849,-35.50471251606941 29.70210210694931,-34.09192360481247 31.114355070778398,-32.674914332490886 32.52543319971301,-31.24939277777448 33.92437150478363,-29.830114889144898 35.32985866824747,-28.40144745694706 36.731119552254675,-26.977388340234757",
      "41.90505368855156,-32.69395747484742 43.18164014471113,-31.162647796265087 44.45703386883251,-29.62145896428265 45.722818841721164,-28.078365055698672 46.9854370101646,-26.523152719665088 48.241096519632265,-24.957823480898515 49.47635311660706,-23.396554367087084 50.70625642617233,-21.817316840356217 51.916848791157825,-20.23452025470324 53.121231726027325,-18.626827073417374 54.30447541638278,-17.009132848726587 55.46054643197567,-15.384525185421808 56.59854381084442,-13.733378434181212 57.70175459315069,-12.071578901773318 58.774999149289215,-10.381464480160503 59.80549905354274,-8.669333272607764 60.79056108891964,-6.92107346355915 61.71054155458696,-5.146393951540813 62.54765257425606,-3.346418538317085 63.29542031474411,-1.4776683177798988 63.90076904296875,0.41781005859374964 64.32472133636475,2.382887077331543 64.4787853706628,4.372914123907686 64.25390302832238,6.34792288444005 63.534512707591055,8.200991186499596 62.29713383527705,9.776205815270078 60.71442330786958,10.999248864781112 58.94893639920046,11.940021610364784 57.08678980795666,12.675638200435788 55.184498033775895,13.259408275266468 53.25016470364062,13.735814640356693 51.29045627919258,14.132557667919901 49.310705046275686,14.46863965655648 47.33345800590905,14.755526898930839 45.35187081008917,15.0060676440713 43.35361113026738,15.230559232085943 41.36360560198082,15.433512788044755 39.37868648191652,15.621674789222014 37.393726520997006,15.800947765202727 35.40220614703139,15.976709847070744 33.3967252872535,16.15410690995632 31.412648706883193,16.334326884895564 29.42771946316352,16.52357764217304 27.433939057307725,16.72707255548594 25.452143891900775,16.94725287631154 23.460698630507977,17.191524095107162 21.46728637320921,17.46480767214671 19.493756452109665,17.770144388545305 17.534803427767475,18.114897261501756 15.574028189945967,18.510559209343047 13.623984803585337,18.96535206215922 11.694143346324564,19.484091004543007 9.776241589494749,20.068956467174576 7.885200029751286,20.71388001677115 6.012518398137763,21.41922944111284 4.171556046651677,22.176369194476866 2.344087195396424,22.98842250108719 0.5335794474929569,23.848920285888017 -1.2570776435080915,24.7496314938413 -3.025639938982203,25.680412404262462 -4.787156744347885,26.63816916740034 -6.538796835998074,27.607557746139356 -8.278835540125147,28.569925193977546 -10.050551912561058,29.526110649295152 -11.821688966080547,30.42859481032938 -13.647645043069499,31.264654922788033 -15.513700637221337,31.971459691226485 -17.43645482622087,32.48389635216445 -19.436265551671386,32.71409701537341 -21.415310162305833,32.582023836672306 -23.360532381385564,32.072295777685945 -25.182038831710816,31.248620760440826 -26.8668710549362,30.18910871555563 -28.427109173685313,28.950296431593596 -29.87520714402199,27.574159030616283 -31.22361106872559,26.09067277908325 -32.47401010915637,24.533700414933264 -33.649050855636595,22.903512346744538 -34.73993612611666,21.23655519511085 -35.7681192654185,19.52077447792981 -36.734423451870676,17.770314891077575 -37.6488059095107,15.979974950593895 -38.50299789169803,14.178242468903772 -39.30667882720009,12.356604974786752 -40.06829516291618,10.503487135469914 -40.787490642815825,8.625071633420884 -41.46012082220986,6.7478645125404 -42.10005888770102,4.857817192538642 -42.701394859701395,2.9376075223088267 -43.25184691447794,1.0219777411461108 -43.75839453862282,-0.9181826149811969 -44.21535337567329,-2.86954950094223 -44.61819176673889,-4.818382549285889 -44.96921510100365,-6.784299767017364 -45.26532936096191,-8.765111541748048 -45.50344052910805,-10.758628261089324 -45.67879778315545,-12.739836307032967 -45.79190929268224,-14.740658907490435 -45.83855023095384,-16.747584985010327 -45.816012928111014,-18.74696415339131 -45.72251810337329,-20.736631392032727 -45.55519694974646,-22.725988711602987 -45.30947122637881,-24.724430946656504 -44.9873217268032,-26.695455428375865 -44.58607262127189,-28.648607677224213 -44.10124374432489,-30.593353670276702 -43.53718892195466,-32.505129282214334 -42.88598689256469,-34.40479397370946 -42.15885316850617,-36.257070334814486 -41.34239979170961,-38.09395435529295 -40.45693625565618,-39.86979912063107 -39.48439538751263,-41.625416107766796 -38.442282644030634,-43.334979289502364 -37.33749867286533,-44.995010340865704 -36.1612973559415,-46.622732964099846 -34.933618536242285,-48.19394835314015 -33.64365806381684,-49.72532818325563 -32.2950621168362,-51.212729070161004 -30.909804248809813,-52.633877229690555 -29.45551105905324,-54.02158637018874 -27.963246952372717,-55.34459345846699 -26.417383633731514,-56.615848274530435 -24.82075408697128,-57.83000440001488 -23.186846015517947,-58.974489696927776 -21.49793410543352,-60.05822374979034 -19.778460500450453,-61.06178169389168 -18.010167794860898,-61.99177888343111 -16.196119469011318,-62.84034349990107 -14.339670669101176,-63.59921774482355 -12.455865894700398,-64.25612388047156 -10.537400122894905,-64.80702260270482 -8.588479121960699,-65.24255314329639 -6.613634659349918,-65.552929738909 -4.617734298040158,-65.72793049887987 -2.617391722774482,-65.75715334621346 -0.6291803380474447,-65.63345149196685 1.3553267108276486,-65.35397246070207 3.3138344525563297,-64.92764019274036 5.235987293720245,-64.36674950122833 7.111715137795545,-63.68634275221267 8.953047622484155,-62.89365430553444 10.73911578299012,-62.009751544659956 12.492702426016331,-61.03485938608647 14.193102811439894,-59.991310068732126 15.862738829595036,-58.87561083217151 17.48104979454074,-57.71112839751877 19.070130932331086,-56.49106857776642 20.620066937545197,-55.23084420577506 22.142046658881007,-53.928745355084544 23.626183101651257,-52.600174374924975 25.093895042254008,-51.2319432669261 26.535201680124736,-49.83846578844823 27.940258876723234,-48.43514193375595 29.340451308363114,-46.99525256515481 30.715508449077603,-45.5435967206955 32.06583766508847,-44.08434974737466 33.412195639312266,-42.59872924983502 34.744625739983164,-41.10090294724214 36.06340706327755,-39.59396741951932 37.368809168669394,-38.08089784677141 38.66109224918764,-36.564550256682566 39.95057095501106,-35.03567710812204 41.23742839160841,-33.496695393277335",
    ];
    const islatentSpaceAnimationPlayed = ref(false);

    let isReadyToStartDemo = ref(false);

    const currentScene = ref(1);

    const isSceneDialog = ref(false);
    const isLoadingOverlay = ref(false);

    const processReasoning = () => {
      isLoadingOverlay.value = true;
      setTimeout(function () {
        isLoadingOverlay.value = false;
        isSceneDialog.value = false;
      }, 3000);
      setTimeout(function () {
        togglelatentSpaceAnimation();
      }, 5000);
    };
    const scenesDescription = [
      "Current AI behaviour",
      "Trained with HITL",
      "Bonus: What if ?",
    ];

    const sceneDirector = () => {
      if (isReadyToStartDemo.value) {
        console.log("Show on");
        if (isCarInSafeMode.value) {
          console.log("!!!!!!!!See danger, slowing down");
          _socket.send(`{"direction":"SLOW"}`);
        } else {
          console.log("Let's gooooooo");
          _socket.send(`{"direction":"UP"}`);
        }
      }
    };

    // computed
    const detectedCount = computed(() => {
      if (typeof detected.value === "object") {
        return detected.value.length;
      } else {
        return 0;
      }
    });

    const detectedItems = computed(() => {
      let _itemList = [];
      if (detected.value) {
        detected.value.forEach((item) => {
          _itemList.push(item?.type);
        });
      }
      return _itemList;
    });

    const isHarmfulPuddle = computed(() => {
      let _isHarmful = false;
      if (detected.value) {
        detected.value.forEach((item) => {
          if (item.type === "puddle") {
            if (item.pert > 0.65) {
              return (_isHarmful = true);
            }
          }
        });
      }
      return _isHarmful;
    });

    const isCarInSafeMode = computed(() => {
      if (detectedItems.value.includes("puddle")) {
        if (currentScene.value === 3 && detectedItems.value.includes("human")) {
          return true;
        } else if (currentScene.value < 2) {
          return true;
        } else {
          return false;
        }
      } else {
        return false;
      }
    });

    // Methods
    const detectionUpdate = (data) => {
      detected.value = data;
    };

    const togglelatentSpaceAnimation = () => {
      let _f = anime({
        targets: "#chart polygon",
        points: [
          {
            value: spacePaths[0],
          },
          {
            value: spacePaths[1],
          },
        ],
        easing: "easeInOutCubic",
        duration: 1200,
        direction: "normal",
        autoplay: false,
      });

      let _b = anime({
        targets: "#chart polygon",
        points: [
          {
            value: spacePaths[1],
          },
          {
            value: spacePaths[0],
          },
        ],
        easing: "easeInOutCubic",
        duration: 1200,
        direction: "normal",
        autoplay: false,
      });
      if (islatentSpaceAnimationPlayed.value) {
        _b.play();
      } else {
        _f.play();
      }

      islatentSpaceAnimationPlayed.value = !islatentSpaceAnimationPlayed.value;
    };
    //watcher
    watch(isReadyToStartDemo, () => {
      console.log("hi watcher");
      if (!isReadyToStartDemo.value) {
        _socket.send(`{"direction":"STOP"}`);
      } else {
        sceneDirector();
      }
    });

    watch(isHarmfulPuddle, () => {
      sceneDirector();
    });

    watch(currentScene, () => {
      if (currentScene.value === 2) {
        // togglelatentSpaceAnimation();
        isSceneDialog.value = true;
      } else if (currentScene.value === 1) {
        togglelatentSpaceAnimation();
      }
    });

    //Life cycle hook
    onMounted(() => {
      _socket.addEventListener("open", function () {
        // _socket.send("Hello Server!");
      });
      // Listen for messages
      _socket.addEventListener("message", async function (event) {
        let _data = JSON.parse(event.data);
        detectionUpdate(_data?.detections);
      });
      document.addEventListener("keypress", (event) => {
        // console.log(event);
        if (event.key === "p") {
          isPresenterView.value = !isPresenterView.value;
        }

        if (event.key === "Enter") {
          isReadyToStartDemo.value = !isReadyToStartDemo.value;
        }

        if (event.key === "1" || event.key === "2" || event.key === "3") {
          console.log("toggling demo scenario");
          currentScene.value = parseInt(event.key);
        }
      });
    });

    return {
      detected,
      detectedCount,
      detectedItems,
      detectionUpdate,
      currentScene,
      scenesDescription,
      togglelatentSpaceAnimation,
      islatentSpaceAnimationPlayed,
      isPresenterView,
      isHarmfulPuddle,
      isReadyToStartDemo,
      isCarInSafeMode,
      _socket,
      isSceneDialog,
      isLoadingOverlay,
      processReasoning,
    };
  },

  data() {
    return {
      isCarViewOnline: false,
      // socket: new WebSocket("ws://localhost:82/client"),
      xVal: 10,
    };
  },

  methods: {},
};
</script>

<style>
.control-container {
  width: 100vw;
  height: 100%;
  background-color: #fefefe;
  display: flex;
}
.control-container.l-space-only {
  display: inital;
}
.left-container {
  width: 60vw;
  background-color: red;
}
.control-container.l-space-only > .left-container {
  display: none;
}
.liveview-block {
  width: 100%;
  background-color: pink;
  aspect-ratio: 16 / 9;
}

.right-container {
  width: 40vw;
  background-color: #39464e;
}
.control-container.l-space-only > .right-container {
  width: 100vw;
}
.chart-block,
.msg-block {
  width: 100%;
  height: 100vh;
}
.car-live-view {
  width: 100%;
}

.overlay-block {
  position: absolute;
  padding: 16px;
  background-color: rgba(0, 0, 0, 0.5);
  right: 24px;
  width: 25vw;
  height: 80vh;
  border-radius: 25px;
  box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
  align-self: center;
}
.overlay-block h1 {
  font-size: 3.5rem;
  color: #fefefe;
}
.overlay-block p {
  font-size: 1rem;
  color: #fafafa;
}
.overlay-block > .liveview-view {
  position: absolute;
  bottom: 16px;
  width: calc(100% - 32px);
  aspect-ratio: 16/9;
  background-color: pink;
  border-radius: 25px;
  overflow: hidden;
}
.liveview-view > p {
  position: absolute;
  top: -40px;
  left: 16px;
}

.scenario-labeling {
  position: absolute;
  top: 16px;
  left: 16px;
  color: #22292e;
}
.scenario-labeling > p {
  margin: 0;
}

.scenario-labeling > .scene-stage {
  font-size: 3rem;
  font-weight: 900;
}

.scene-description {
  font-size: 1.5rem;
}

.control-hint {
  position: absolute;
  bottom: 0;
  height: 32px;
  width: 100%;
  margin: 8px !important;
  color: #22292e;
}

svg.chart {
  position: relative;
  fill: grey;
}
svg > .item-spot {
  z-index: 1;
  fill: white;
}

.item-spot.paddle {
  fill: lightblue;
}
.item-spot.human {
  fill: lightgreen;
}
</style>
